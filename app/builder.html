<link rel="ractive" href="tab.html" name="tab">
<link rel="ractive" href="tabtitle.html" name="tabtitle">
<link rel="ractive" href="tabpane.html" name="tabpane">
<link rel="ractive" href="collapsible.html" name="collapsible">

<div class="mv4">
  <tab>
    <div class="tab-selector flex">
      <tabtitle target="tab-select">
        <h2 class="f4 bg-near-black white mv0 pv2 ph3">
          Select Icons
        </h2>
      </tabtitle>

      <tabtitle target="tab-customize">
        <h2 class="f4 gray mv0 pv2 ph3 pointer">
          Customize Names
        </h2>
      </tabtitle>

      <tabtitle target="tab-download">
        <h2 class="f4 gray mv0 pv2 ph3 pointer">
          Download
        </h2>
      </tabtitle>
    </div>

    <div class="tab-container pa3 bt">
      <tabpane id="tab-select" active="true">
        <form>
          <input name="filter" type="search" value="{{filter}}" placeholder="Search"/>
          <input id="size" name="size" type="range" min="16" max="128" value="{{size}}"/>
          <label for="size">{{size}}px</label>
        </form>

        {{#sets}}
        <collapsible>
          {{#partial title}}
          {{name}}
          <small class="ml3 gray fw4">
            {{version}} - License: {{license}} -
            <a href="{{homepage}}" title="Home page" target="_blank" rel="noopener">
              {{homepage}}
            </a>
          </small>
          {{/partial}}

          <div class="flex flex-wrap">
            {{#iconList}}
            <div class="icon pa3 ma2 pointer selected-{{.selected}} hidden-{{.hidden}}" on-click="select">
              <div class="sizer">
                <svg class="w-100 h-100">
                  <use xlink:href="font-awesome.svg#{{name}}"/>
                </svg>
              </div>
            </div>
            {{/iconList}}
          </div>
        </collapsible>
        {{/sets}}
      </tabpane>

      <tabpane id="tab-customize">
        <div class="flex flex-wrap">
          {{#selected:key}}
          <div class="pa3 ma2 flex">
            <label for="icon-{{key}}" class="pointer mr3">
              <div class="sizer">
                <svg class="w-100 h-100">
                  <use xlink:href="font-awesome.svg#{{key}}"/>
                </svg>
              </div>
            </label>
            <input id="icon-{{key}}" name="icon-{{}}" type="text" value="{{name}}"/>
            <button class="pointer" on-click="deselect">&times;</button>
          </div>
          {{/selected}}
        </div>
      </tabpane>

      <tabpane id="tab-download">
        <textarea class="w-100" rows="32" twoway="false">{{JSON.stringify(selected, null, 2)}}</textarea>
      </tabpane>
    </div>
  </tab>
</div>

<style>
  .selected-true {
    border: 1px solid #36c;
  }
  .hidden-true {
    display: none;
  }
</style>

<script>
  component.exports = {
    data: () => ({
      filter: '',
      size: 24,
      sets: [],
      selected: {}
    }),

    on: {
      init: function() {
        const size = this.get('size')
        const styleElement = document.createElement('style')
        styleElement.innerHTML = `.sizer{width:${size}px;height:${size}px}`
        styleElement.setAttribute('id', 'builder-style')
        document.head.appendChild(styleElement)
      },

      select: function(e) {
        const keypath = e.get('@keypath')
        const selected = e.get(`${keypath}.selected`)
        const name = e.get('name')

        // TODO: there is better way to do this
        if (!selected) {
          this.set(`${keypath}.selected`, true)

          const iconset = e.get('id')
          this.set(`selected.${name}`, { name, keypath, iconset })
        } else {
          this.set(`${keypath}.selected`, false)

          let selected = this.get('selected')
          delete selected[name]
          this.set('selected', selected)
        }
      },

      deselect: function(e) {
        const keypath = e.get('keypath')
        this.set(`${keypath}.selected`, false)

        let selected = this.get('selected')
        delete selected[e.get('key')]
        this.set('selected', selected)
      }
    },

    observe: {
      filter: function(filter, _) {
        if (filter) {
          this.get('sets').forEach((iconSet, setIndex) => {
            iconSet.iconList.forEach((icon, iconIndex) => {
              this.set(
                `sets.${setIndex}.iconList.${iconIndex}.hidden`,
                // TODO: search support synonym
                !(new RegExp(filter, 'i')).test(icon.name)
              )
            })
          })
        } else {
          this.set('sets.*.iconList.*.hidden', false)
        }
      },

      size: function(size, _) {
        const styleElement = document.querySelector('#builder-style')
        if (styleElement) {
          styleElement.innerHTML = `.sizer{width:${size}px;height:${size}px}`
        }
      }
    }
  }
</script>
